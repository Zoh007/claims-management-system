{% extends 'base.html' %}

{% block title %}Claims{% endblock %}

{% block content %}
<div class="px-4 sm:px-6 lg:px-8" x-data="{ search: '{{ search }}', statusFilter: '{{ status_filter }}', insurerFilter: '{{ insurer_filter }}' }">
  <div class="sm:flex sm:items-center">
    <div class="sm:flex-auto">
      <h1 class="text-3xl font-semibold text-slate-900 tracking-tight">Claims</h1>
      <p class="mt-2 text-sm text-slate-600">Search, filter, and review claims quickly.</p>
    </div>
  </div>

  {% if user.is_staff %}
  <!-- Small KPI row with live updates via SSE (visible to staff only) -->
  <div class="mt-4 grid grid-cols-2 sm:grid-cols-4 gap-3" x-data="kpis()" x-init="init()">
    <div class="bg-white/80 border rounded-lg p-4 shadow-sm">
      <div class="text-xs text-slate-500">Total Claims</div>
      <div class="text-xl font-semibold text-slate-900" x-text="format(stats.total_claims)">{{ stats.total_claims }}</div>
    </div>
    <div class="bg-white/80 border rounded-lg p-4 shadow-sm">
      <div class="text-xs text-slate-500">Flagged Claims</div>
      <div class="text-xl font-semibold text-slate-900" x-text="format(stats.flagged_claims)">{{ stats.flagged_claims }}</div>
    </div>
    <div class="bg-white/80 border rounded-lg p-4 shadow-sm">
      <div class="text-xs text-slate-500">Total Billed</div>
      <div class="text-xl font-semibold text-slate-900" x-text="'$' + format(stats.total_billed)">${{ stats.total_billed }}</div>
    </div>
    <div class="bg-white/80 border rounded-lg p-4 shadow-sm">
      <div class="text-xs text-slate-500">Avg Underpayment</div>
      <div class="text-xl font-semibold text-slate-900" x-text="'$' + format(stats.average_underpayment)">${{ stats.average_underpayment }}</div>
    </div>
  </div>
  {% endif %}

  <!-- Search and Filters -->
  <div class="mt-4 bg-white/80 border rounded-xl px-4 py-4 sm:px-6 sm:py-5 shadow-sm">
    <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
      <!-- Search -->
      <div>
        <label for="search" class="block text-xs font-medium text-gray-700">Search</label>
        <input type="text" id="search" x-model="search" placeholder="Patient, claim ID, or insurer..."
               class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
               hx-get="{% url 'claims:index' %}" hx-trigger="keyup changed delay:400ms"
               hx-target="#claims-table" hx-include="[name='search'], [name='status'], [name='insurer']">
        <input type="hidden" name="search" x-bind:value="search">
      </div>

      <!-- Status Filter -->
      <div>
        <label for="status_filter" class="block text-xs font-medium text-gray-700">Status</label>
        <select id="status_filter" x-model="statusFilter"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                hx-get="{% url 'claims:index' %}" hx-trigger="change" hx-target="#claims-table"
                hx-include="[name='search'], [name='status'], [name='insurer']">
          <option value="">All</option>
          {% for status in statuses %}
          <option value="{{ status }}" {% if status == status_filter %}selected{% endif %}>{{ status }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="status" x-bind:value="statusFilter">
      </div>

      <!-- Insurer Filter -->
      <div>
        <label for="insurer_filter" class="block text-xs font-medium text-gray-700">Insurer</label>
        <select id="insurer_filter" x-model="insurerFilter"
                class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm"
                hx-get="{% url 'claims:index' %}" hx-trigger="change" hx-target="#claims-table"
                hx-include="[name='search'], [name='status'], [name='insurer']">
          <option value="">All</option>
          {% for insurer in insurers %}
          <option value="{{ insurer }}" {% if insurer == insurer_filter %}selected{% endif %}>{{ insurer }}</option>
          {% endfor %}
        </select>
        <input type="hidden" name="insurer" x-bind:value="insurerFilter">
      </div>
    </div>
  </div>

  <!-- Results table (HTMX swaps only this) -->
  <div class="mt-6" id="claims-table" hx-target="this" hx-swap="outerHTML">
    {% include 'partials/claims_table.html' %}
  </div>

  
</div>
{% endblock %}
